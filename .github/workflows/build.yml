name: Build ZMK Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root
    
    strategy:
      matrix:
        include:
          - board: nrfmicro_13
            shield: k30
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Fix keymap syntax
        run: |
          echo "=== Fixing keymap file ==="
          if [ -f "config/boards/shields/k30/k30.keymap" ]; then
            # 备份原始文件
            cp config/boards/shields/k30/k30.keymap config/boards/shields/k30/k30.keymap.backup
            
            # 修复键码名称
            sed -i '
              s/&kp NUM_LOCK/&kp NLCK/g;
              s/&kp FSLH/&kp KP_SLASH/g;
              s/&kp STAR/&kp KP_ASTERISK/g;
              s/&kp MINUS/&kp KP_MINUS/g;
            ' config/boards/shields/k30/k30.keymap
            
            echo "Keymap syntax fixed"
          else
            echo "WARNING: k30.keymap not found, creating a simple one"
            mkdir -p config/boards/shields/k30
            cat > config/boards/shields/k30/k30.keymap << 'EOF'
#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>

/ {
    keymap {
        compatible = "zmk,keymap";
        default_layer {
            bindings = <
                &kp A &kp B
            >;
        };
    };
};
EOF
          fi

      - name: Initialize ZMK workspace
        run: |
          echo "=== Initializing ZMK ==="
          west init -l config
          west update
          
      - name: Export Zephyr environment
        run: |
          echo "=== Setting up Zephyr environment ==="
          west zephyr-export
          
      - name: Verify Zephyr setup
        run: |
          echo "=== Verifying Zephyr ==="
          if [ -n "$ZEPHYR_BASE" ]; then
            echo "ZEPHYR_BASE: $ZEPHYR_BASE"
          else
            echo "ZEPHYR_BASE not set, but continuing..."
          fi
          
          # 检查 Zephyr 配置文件是否存在
          if [ -f "zephyr/share/zephyr-package/cmake/ZephyrConfig.cmake" ]; then
            echo "✓ ZephyrConfig.cmake found"
          else
            echo "✗ ZephyrConfig.cmake not found"
            find . -name "ZephyrConfig.cmake" | head -5
          fi

      - name: Build firmware
        run: |
          echo "=== Building firmware ==="
          echo "Board: ${{ matrix.board }}"
          echo "Shield: ${{ matrix.shield }}"
          
          # 设置 Zephyr 基础路径（如果环境变量未设置）
          export ZEPHYR_BASE="$GITHUB_WORKSPACE/zephyr"
          
          # 构建命令
          west build -b ${{ matrix.board }} -s zmk/app -- \
            -DZMK_CONFIG="$GITHUB_WORKSPACE/config" \
            -DSHIELD=${{ matrix.shield }}

      - name: Check build output
        run: |
          echo "=== Build results ==="
          if [ -f "build/zephyr/zmk.uf2" ]; then
            echo "✓ Build successful - UF2 file found"
            ls -lh build/zephyr/zmk.uf2
          elif [ -f "build/zephyr/zmk.hex" ]; then
            echo "✓ Build successful - HEX file found"
            ls -lh build/zephyr/zmk.hex
          else
            echo "✗ Build failed - no firmware files"
            echo "Build directory contents:"
            find build/ -type f | head -20
            exit 1
          fi

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.shield }}-${{ matrix.board }}
          path: |
            build/zephyr/zmk.uf2
            build/zephyr/zmk.hex
