name: Build K30 Keyboard - Full Firmware with USB Logging

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root

    steps:
      - name: Checkout your repo (to get your k30 config)
        uses: actions/checkout@v4

      - name: Clone and set up official ZMK
        run: |
          # 1. 克隆官方 ZMK
          git clone https://github.com/zmkfirmware/zmk.git
          cd zmk

          # 2. 初始化 West workspace using ZMK's app as manifest
          west init -l app

          # 3. 拉取所有依赖（zephyr, modules, etc.）
          west update

          # 4. 导出 Zephyr 环境
          west zephyr-export

          # 5. 创建 k30 shield 配置目录
          mkdir -p app/boards/shields/k30

          # 6. 检查并复制配置文件，如果存在
          if [ -d "$GITHUB_WORKSPACE/config/boards/shields/k30" ]; then
            echo "找到现有k30配置，正在复制..."
            cp -r "$GITHUB_WORKSPACE/config/boards/shields/k30"/* app/boards/shields/k30/
          else
            echo "未找到现有k30配置，创建基本配置..."
            # 创建基本的k30.conf文件
            echo "# K30键盘配置" > app/boards/shields/k30/k30.conf
            # 创建基本的k30.keymap文件
            echo "/ {\n    keymap {\n        compatible = \"zmk,keymap\";\n        default_layer {\n            bindings = <\&kp ESC>;\n        };\n    };\n};" > app/boards/shields/k30/k30.keymap
            # 创建基本的k30.dtsi文件
            echo "#include <dt-bindings/zmk/matrix_transform.h>\n\n/ {\n    keymap {\n        compatible = \"zmk,keymap\"\n    };\n};\n\n&pro_micro_i2c {\n    status = \"okay\";\n};\n\n&pro_micro_spi {\n    status = \"okay\";\n};\n\n&spi0 {\n    status = \"okay\";\n};\n\n&spi1 {\n    status = \"okay\";\n};" > app/boards/shields/k30/k30.dtsi
          fi

      - name: Configure USB Logging
        working-directory: zmk
        run: |
          # 启用 USB 串口调试
          echo "CONFIG_UART_CONSOLE=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_USB_DEVICE_STACK=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_USB_DEVICE_PRODUCT=\"ZMK Keyboard\"" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_USB_CDC_ACM=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_USB_CDC_ACM_RINGBUF_SIZE=16384" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_LOG=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_LOG_BACKEND_SERIAL=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_LOG_BACKEND_UART_OUTPUT_TEXT=y" >> app/boards/shields/k30/k30.conf

      - name: Build firmware
        working-directory: zmk
        run: |
          west build -b nrfmicro_13 -s app -- -DSHIELD=k30

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: k30-full-firmware
          path: zmk/build/zephyr/zmk.uf2
