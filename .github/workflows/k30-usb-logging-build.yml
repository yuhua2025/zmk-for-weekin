name: Build K30 Keyboard - Full Firmware with USB Logging

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: zmkfirmware/zmk-build-arm:stable
      options: --user root

    steps:
      - name: Checkout your repo (to get your k30 config)
        uses: actions/checkout@v4

      - name: Clone and set up official ZMK
        run: |
          # 1. 克隆官方 ZMK
          git clone https://github.com/zmkfirmware/zmk.git
          cd zmk

          # 2. 初始化 West workspace using ZMK's app as manifest
          west init -l app

          # 3. 拉取所有依赖（zephyr, modules, etc.）
          west update

          # 4. 导出 Zephyr 环境
          west zephyr-export

          # 5. 创建 k30 shield 配置目录
          mkdir -p app/boards/shields/k30

          # 6. 检查并复制配置文件，如果存在
          if [ -d "$GITHUB_WORKSPACE/config/boards/shields/k30" ]; then
            echo "找到现有k30配置，正在复制..."
            cp -r "$GITHUB_WORKSPACE/config/boards/shields/k30"/* app/boards/shields/k30/
          else
            echo "未找到现有k30配置，创建完整的shield配置..."
            # 创建shield目录
            mkdir -p app/boards/shields/k30
            
            # 1. 创建Kconfig.defconfig文件（shield必需）
            echo "# K30 Shield Configuration\nconfig SHIELD_K30\n    bool \"Enable K30 keyboard shield\"\n    depends on BOARD_NRFMICRO_13\n    help\n      Enable support for the K30 keyboard shield." > app/boards/shields/k30/Kconfig.defconfig
            
            # 2. 创建Kconfig.shield文件（shield必需）
            echo "# K30 Shield Configuration\nconfig SHIELD_K30\n    def_bool $(shields_list_contains,k30)" > app/boards/shields/k30/Kconfig.shield
            
            # 3. 创建基本的k30.conf文件
            echo "# K30键盘配置" > app/boards/shields/k30/k30.conf
            
            # 4. 创建基本的k30.keymap文件
            echo "/ {\n    keymap {\n        compatible = \\\"zmk,keymap\\\";\n        default_layer {\n            bindings = <\&kp ESC>;\n        };\n    };\n};" > app/boards/shields/k30/k30.keymap
            
            # 5. 创建正确的k30.dtsi文件，修复语法错误
            echo "#include <dt-bindings/zmk/matrix_transform.h>\n\n/ {\n    chosen {\n        zmk,matrix-transform = <&matrix_transform>;\n    };\n    \n    matrix_transform: matrix_transform {\n        compatible = \\\"zmk,matrix-transform\\\";\n        columns = <1>;\n        rows = <1>;\n        map = <RC(0,0)>;\n    };\n};\n\n&pro_micro_i2c {\n    status = \\\"okay\\\";\n};\n\n&pro_micro_spi {\n    status = \\\"okay\\\";\n};\n\n&spi0 {\n    status = \\\"okay\\\";\n};\n\n&spi1 {\n    status = \\\"okay\\\";\n};" > app/boards/shields/k30/k30.dtsi
            
            # 6. 创建必要的CMakeLists.txt文件
            echo "# CMakeLists.txt for K30 shield\nadd_shield(k30)" > app/boards/shields/k30/CMakeLists.txt
            
            # 7. 创建shield.overlay文件（必需）
            echo "/ {
    chosen {
        zmk,kscan = &kscan0;
    };

    kscan0: kscan_0 {
        compatible = \"zmk,kscan-matrix\";
        diode-direction = \"col2row\";
        row-gpios = <&gpio0 29 GPIO_ACTIVE_LOW>;
        col-gpios = <&gpio0 28 GPIO_ACTIVE_HIGH>;
    };

    leds {
        compatible = \"gpio-leds\";
    };
};" > app/boards/shields/k30/k30.overlay
            
            # 8. 创建shield.dts文件（必需）
            echo "/dts-v1/;
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <zephyr/dt-bindings/zmk/matrix_transform.h>
#include \"k30.dtsi\"" > app/boards/shields/k30/k30.dts
          fi

          # 显示创建的文件，用于调试
          echo "创建的shield文件结构："
          ls -la app/boards/shields/k30/
          
          # 显示shield文件内容，用于详细调试
          echo "\nKconfig.defconfig内容："
          cat app/boards/shields/k30/Kconfig.defconfig
          echo "\nKconfig.shield内容："
          cat app/boards/shields/k30/Kconfig.shield
          echo "\nCMakeLists.txt内容："
          cat app/boards/shields/k30/CMakeLists.txt
          
          # 检查ZMK是否能识别到shield
          echo "\n检查可用的shields："
          cd app
          west build -b nrfmicro_13 -t list-shields || echo "列出shields失败，但继续执行"

      - name: Configure USB Logging
        working-directory: zmk
        run: |
          # 启用 USB 串口调试
          echo "CONFIG_UART_CONSOLE=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_USB_DEVICE_STACK=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_USB_DEVICE_PRODUCT=\"ZMK Keyboard\"" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_USB_CDC_ACM=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_USB_CDC_ACM_RINGBUF_SIZE=16384" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_LOG=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_LOG_BACKEND_SERIAL=y" >> app/boards/shields/k30/k30.conf
          echo "CONFIG_LOG_BACKEND_UART_OUTPUT_TEXT=y" >> app/boards/shields/k30/k30.conf

      - name: Build firmware
        working-directory: zmk
        run: |
          west build -b nrfmicro_13 -s app -- -DSHIELD=k30

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: k30-full-firmware
          path: zmk/build/zephyr/zmk.uf2
