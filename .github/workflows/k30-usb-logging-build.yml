name: Build K30 Keyboard - USB Logging Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: docker.io/zmkfirmware/zmk-build-arm:3.5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Cache west modules
        uses: actions/cache@v4
        env:
          cache-name: cache-zephyr-modules
        with:
          path: |
            modules/
            tools/
            zephyr/
            bootloader/
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('app/west.yml') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      - name: 调试目录结构
        run: |
          echo "当前目录结构："
          find . -maxdepth 3 -type f -name "west.yml"
          ls -la
          echo "app目录内容："
          ls -la app/ 2>/dev/null || echo "app目录不存在"
      - name: 初始化workspace (west init)
        run: |
          # 根据GitHub仓库结构，首先尝试根目录初始化
          if [ -f "west.yml" ]; then
            echo "在根目录中找到west.yml，直接使用当前目录初始化"
            west init -l .
          elif [ -f "app/west.yml" ]; then
            echo "在app目录中找到west.yml，使用app目录初始化"
            west init -l app
          else
            # 作为备选方案，尝试查找项目中所有的west.yml文件
            WEST_FILE=$(find . -name "west.yml" -type f 2>/dev/null | head -n 1)
            if [ -n "$WEST_FILE" ]; then
              WEST_DIR=$(dirname "$WEST_FILE")
              echo "找到west.yml文件在：$WEST_FILE"
              echo "将使用目录：$WEST_DIR 进行初始化"
              west init -l "$WEST_DIR"
            else
              echo "未找到west.yml文件，尝试在根目录直接初始化"
              west init -m https://github.com/zmkfirmware/zmk.git .
            fi
          fi
      - name: Update modules (west update)
        run: west update --fetch-opt=--filter=tree:0
      - name: Export Zephyr CMake package (west zephyr-export)
        run: west zephyr-export
      - name: Check and create USB logging snippet
        run: |
          # 确保zmk-usb-logging snippet存在
          if [ ! -d "app/snippets/zmk-usb-logging" ]; then
            echo "创建zmk-usb-logging snippet目录"
            mkdir -p app/snippets/zmk-usb-logging
            
            # 创建snippet配置文件
            echo "name: zmk-usb-logging" > app/snippets/zmk-usb-logging/snippet.yml
            echo "append: " >> app/snippets/zmk-usb-logging/snippet.yml
            echo "  - zmk-usb-logging.conf" >> app/snippets/zmk-usb-logging/snippet.yml
            echo "  - zmk-usb-logging.overlay" >> app/snippets/zmk-usb-logging/snippet.yml
            
            # 创建配置文件
            echo "CONFIG_ZMK_USB_LOGGING=y" > app/snippets/zmk-usb-logging/zmk-usb-logging.conf
            
            # 创建设备树覆盖文件
            mkdir -p app/snippets/zmk-usb-logging
            echo '\/' > app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '{' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '    chosen {' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '        zephyr,console = &snippet_zmk_usb_logging_uart;' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '        zephyr,shell-uart = &snippet_zmk_usb_logging_uart;' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '    };' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '};' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '&zephyr_udc0 {' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '    snippet_zmk_usb_logging_uart: snippet_zmk_usb_logging_uart {' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '        compatible = "zephyr,cdc-acm-uart";' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '        label = "CDC_ACM_0";' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '    };' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
            echo '};' >> app/snippets/zmk-usb-logging/zmk-usb-logging.overlay
          else
            echo "zmk-usb-logging snippet已存在"
          fi

          # 确保k30目录存在
          mkdir -p app/boards/shields/k30

          # 确保k30.conf包含必要的USB日志依赖配置
          if [ -f "app/boards/shields/k30/k30.conf" ]; then
            echo "检查k30.conf是否已包含USB日志配置"
            # 检查是否已包含配置
            if ! grep -q "CONFIG_ZMK_USB_LOGGING" app/boards/shields/k30/k30.conf; then
              echo "添加USB日志依赖配置到k30.conf"
              echo 'CONFIG_LOG=y' >> app/boards/shields/k30/k30.conf
              echo 'CONFIG_USB_DEVICE=y' >> app/boards/shields/k30/k30.conf
              echo 'CONFIG_USB_DEVICE_STACK=y' >> app/boards/shields/k30/k30.conf
              echo 'CONFIG_SERIAL_SUPPORT_INTERRUPT=y' >> app/boards/shields/k30/k30.conf
              echo 'CONFIG_CONSOLE=y' >> app/boards/shields/k30/k30.conf
              echo 'CONFIG_USB_CDC_ACM=y' >> app/boards/shields/k30/k30.conf
              echo 'CONFIG_UART_CONSOLE=y' >> app/boards/shields/k30/k30.conf
              echo 'CONFIG_UART_INTERRUPT_DRIVEN=y' >> app/boards/shields/k30/k30.conf
            else
              echo "k30.conf已包含USB日志配置"
            fi
          else
            echo "创建k30.conf并添加USB日志配置"
            echo 'CONFIG_LOG=y' > app/boards/shields/k30/k30.conf
            echo 'CONFIG_USB_DEVICE=y' >> app/boards/shields/k30/k30.conf
            echo 'CONFIG_USB_DEVICE_STACK=y' >> app/boards/shields/k30/k30.conf
            echo 'CONFIG_SERIAL_SUPPORT_INTERRUPT=y' >> app/boards/shields/k30/k30.conf
            echo 'CONFIG_CONSOLE=y' >> app/boards/shields/k30/k30.conf
            echo 'CONFIG_USB_CDC_ACM=y' >> app/boards/shields/k30/k30.conf
            echo 'CONFIG_UART_CONSOLE=y' >> app/boards/shields/k30/k30.conf
            echo 'CONFIG_UART_INTERRUPT_DRIVEN=y' >> app/boards/shields/k30/k30.conf
          fi

      - name: Debug Information
        run: |
          echo "工作目录: $(pwd)"
          echo "列出根目录内容..."
          ls -la
          echo "检查app目录..."
          ls -la app/ 2>/dev/null || echo "app目录不存在"
          echo "列出snippets目录内容..."
          ls -la app/snippets/ 2>/dev/null || echo "snippets目录不存在"
          echo "列出zmk-usb-logging目录内容..."
          ls -la app/snippets/zmk-usb-logging/ 2>/dev/null || echo "zmk-usb-logging snippet不存在"
          echo "检查snippet配置文件..."
          if [ -f "app/snippets/zmk-usb-logging/snippet.yml" ]; then
            echo "snippet.yml内容:"
            cat app/snippets/zmk-usb-logging/snippet.yml
          fi
          echo "列出k30配置文件内容..."
          if [ -f "app/boards/shields/k30/k30.conf" ]; then
            echo "k30.conf内容:"
            cat app/boards/shields/k30/k30.conf
          fi

      - name: Build firmware with USB Logging
        run: |
          echo "开始构建启用USB日志的K30固件..."

          # 动态查找app目录
          APP_DIR=$(find . -name "CMakeLists.txt" -path "*/app/CMakeLists.txt" | xargs dirname)
          if [ -z "$APP_DIR" ]; then
            echo "Error: Could not find app directory with CMakeLists.txt"
            exit 1
          fi

          echo "Building from: $APP_DIR"

          # 使用相对路径进行构建
          RELATIVE_APP_DIR=$(realpath --relative-to="$(pwd)" "$APP_DIR")

          echo "构建命令: west build -b nrfmicro_13 -s $RELATIVE_APP_DIR -- -DSHIELD=k30 -S zmk-usb-logging"

          # 显示Kconfig依赖关系以调试问题
          west build -b nrfmicro_13 -s "$RELATIVE_APP_DIR" -- -DSHIELD=k30 -S zmk-usb-logging -t guiconfig || echo "Kconfig GUI不可用，继续构建..."

          # 捕获错误并输出详细日志
          west build -b nrfmicro_13 -s "$RELATIVE_APP_DIR" -- -DSHIELD=k30 -S zmk-usb-logging || {
            echo "构建失败! 检查常见问题..."
            find . -name "zephyr.log" -exec cat {} \;
            # 显示最终的配置文件内容以调试
            if [ -f "build/zephyr/.config" ]; then
              echo "最终配置文件内容:"
              grep -E "USB|LOG|SERIAL|CONSOLE" build/zephyr/.config
            fi
            exit 1
          }

      - name: Verify Build Output
        run: |
          echo "检查构建输出..."
          # 查找所有可能的固件文件位置
          FIRMWARE_FILES=$(find . -name "zmk.hex" -o -name "zmk.uf2")

          if [ -z "$FIRMWARE_FILES" ]; then
            echo "错误: 未找到固件文件!"
            # 检查标准构建目录是否存在
            if [ -d "build/zephyr" ]; then
              echo "构建目录内容:"
              ls -la build/zephyr/
              # 显示构建日志以帮助调试
              if [ -f "build/zephyr/build.log" ]; then
                echo "构建日志内容:"
                tail -n 100 build/zephyr/build.log
              fi
            else
              echo "构建目录不存在，检查其他可能的位置..."
              find . -name "build" -type d | xargs ls -la 2>/dev/null || echo "未找到构建目录"
            fi
            exit 1
          else
            echo "找到固件文件:"
            echo "$FIRMWARE_FILES"
            # 显示固件文件的详细信息
            for file in $FIRMWARE_FILES; do
              echo "文件信息: $file"
              ls -lh "$file"
            done
          fi

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: k30-usb-logging-firmware-${{ github.sha }}
          path: |
            build/zephyr/zmk.uf2
            build/zephyr/zmk.hex
            build/zephyr/zephyr.bin
          if-no-files-found: warn
          retention-days: 14
